# Generated by Django 5.2.5 on 2025-09-15 07:03
# Fixed to handle cases where indexes don't exist

from django.db import migrations, connection
import logging

logger = logging.getLogger(__name__)


def rename_indexes_safely(apps, schema_editor):
    """Safely rename indexes, creating them if they don't exist."""

    with connection.cursor() as cursor:
        # First index: rename if exists, then ensure it exists with new name
        cursor.execute(
            "ALTER INDEX IF EXISTS authenticat_service_4e4f1c_idx "
            "RENAME TO authenticat_service_e48650_idx"
        )
        # Ensure the index exists with the new name
        cursor.execute(
            "CREATE INDEX IF NOT EXISTS authenticat_service_e48650_idx "
            "ON authentication_token (service, user_id)"
        )
        logger.info("Ensured index authenticat_service_e48650_idx exists")

        # Second index: rename if exists, then ensure it exists with new name
        cursor.execute(
            "ALTER INDEX IF EXISTS authenticat_last_re_7b8e5c_idx "
            "RENAME TO authenticat_last_re_3d203b_idx"
        )
        # Ensure the index exists with the new name
        cursor.execute(
            "CREATE INDEX IF NOT EXISTS authenticat_last_re_3d203b_idx "
            "ON authentication_token (last_refreshed)"
        )
        logger.info("Ensured index authenticat_last_re_3d203b_idx exists")


def reverse_rename_indexes(apps, schema_editor):
    """Reverse the index renaming."""

    with connection.cursor() as cursor:
        # Reverse first index
        try:
            cursor.execute(
                "ALTER INDEX IF EXISTS authenticat_service_e48650_idx "
                "RENAME TO authenticat_service_4e4f1c_idx"
            )
        except Exception as e:
            logger.warning(f"Could not reverse rename index authenticat_service_e48650_idx: {e}")

        # Reverse second index
        try:
            cursor.execute(
                "ALTER INDEX IF EXISTS authenticat_last_re_3d203b_idx "
                "RENAME TO authenticat_last_re_7b8e5c_idx"
            )
        except Exception as e:
            logger.warning(f"Could not reverse rename index authenticat_last_re_3d203b_idx: {e}")


class Migration(migrations.Migration):

    dependencies = [
        ('authentication', '0002_migrate_tokens_from_events'),
    ]

    operations = [
        migrations.RunPython(
            rename_indexes_safely,
            reverse_rename_indexes,
        ),
    ]
