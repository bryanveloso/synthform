name: Deploy to OrbStack

on:
  push:
    branches: [ main ]

env:
  DEBUG: False
  ALLOWED_HOSTS: "*"
  DATABASE_URL: postgresql://synthform:synthform@db:5432/synthform
  REDIS_URL: redis://redis:6379/0

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 10
      
    - name: Create production .env file
      run: |
        cd apps/server
        cat > .env << EOF
        DEBUG=${{ env.DEBUG }}
        SECRET_KEY=${{ secrets.SECRET_KEY }}
        ALLOWED_HOSTS=${{ env.ALLOWED_HOSTS }}
        DATABASE_URL=${{ env.DATABASE_URL }}
        REDIS_URL=${{ env.REDIS_URL }}
        TWITCH_CLIENT_ID=${{ secrets.TWITCH_CLIENT_ID }}
        TWITCH_CLIENT_SECRET=${{ secrets.TWITCH_CLIENT_SECRET }}
        TWITCH_EVENTSUB_SECRET=${{ secrets.TWITCH_EVENTSUB_SECRET }}
        FERNET_KEY=${{ secrets.FERNET_KEY }}
        EOF
    
    - name: Check changes and deploy selectively
      run: |
        # Handle null SHA (force push, new branch, or first push)
        BEFORE_SHA="${{ github.event.before }}"
        if [ "$BEFORE_SHA" = "0000000000000000000000000000000000000000" ] || [ -z "$BEFORE_SHA" ]; then
          echo "No previous SHA available, checking last commit only"
          CHANGED_FILES=$(git diff --name-only HEAD~1..HEAD 2>/dev/null || git ls-files)
        else
          CHANGED_FILES=$(git diff --name-only "$BEFORE_SHA"..HEAD 2>/dev/null || git ls-files)
        fi

        echo "=== Changed files ==="
        echo "$CHANGED_FILES"
        echo "===================="

        REBUILD_SERVER=false
        REBUILD_OVERLAYS=false
        REBUILD_ALL=false

        # Server changes (includes both Django app and Twitch service since they share code)
        if echo "$CHANGED_FILES" | grep -q "apps/server"; then
          echo "✓ Detected: Server code changed"
          REBUILD_SERVER=true
        fi

        # Overlays changes
        if echo "$CHANGED_FILES" | grep -q "apps/overlays"; then
          echo "✓ Detected: Overlay code changed"
          REBUILD_OVERLAYS=true
        fi

        # Infrastructure changes (compose files, Dockerfiles)
        if echo "$CHANGED_FILES" | grep -qE "docker-compose|Dockerfile"; then
          echo "✓ Detected: Infrastructure changed"
          REBUILD_ALL=true
        fi

        # Execute rebuilds with force-recreate to ensure containers restart
        if [ "$REBUILD_ALL" = true ]; then
          echo ">>> Rebuilding ALL containers"
          docker compose -f docker-compose.prod.yml up --build --force-recreate -d --remove-orphans
        else
          if [ "$REBUILD_SERVER" = true ]; then
            echo ">>> Rebuilding server, twitch, celery, ironmon containers"
            docker compose -f docker-compose.prod.yml up --build --force-recreate -d server twitch celery ironmon
          fi

          if [ "$REBUILD_OVERLAYS" = true ]; then
            echo ">>> Rebuilding overlays container"
            docker compose -f docker-compose.prod.yml up --build --force-recreate -d overlays
          fi
        fi

        # Ensure all services are running (start any stopped services, no rebuild)
        docker compose -f docker-compose.prod.yml up -d
    
    - name: Wait for services to be ready
      run: |
        timeout 60 sh -c 'until docker compose -f docker-compose.prod.yml exec -T db pg_isready -U synthform -d synthform; do sleep 1; done'
        sleep 5
    
    - name: Collect static files
      run: |
        docker compose -f docker-compose.prod.yml exec -T server uv run python manage.py collectstatic --noinput
    
    - name: Clean up old Docker images
      run: |
        docker image prune -f
